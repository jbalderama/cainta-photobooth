<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Photobooth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .photo-frame {
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            border: 8px solid #fff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .countdown {
            font-size: 8rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .capture-flash {
            animation: flash 0.3s ease-out;
        }
        @keyframes flash {
            0% { background: rgba(255,255,255,0); }
            50% { background: rgba(255,255,255,0.8); }
            100% { background: rgba(255,255,255,0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-600 to-blue-600 min-h-screen">
    <!-- Admin Interface -->
    <div id="adminPanel" class="fixed top-4 right-4 bg-white rounded-lg p-4 shadow-lg z-50 hidden">
        <h3 class="text-lg font-bold mb-4">Admin Panel</h3>
        
        <!-- Layout Selection -->
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Layout Size:</label>
            <select id="layoutSelect" class="w-full p-2 border rounded">
                <option value="6x4">6x4 inch (Landscape)</option>
                <option value="2x6">2x6 inch (Portrait)</option>
            </select>
        </div>
        
        <!-- Background Upload -->
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Background Design:</label>
            <input type="file" id="backgroundUpload" accept="image/*" class="w-full p-2 border rounded">
            <button id="clearBackground" class="mt-2 px-3 py-1 bg-red-500 text-white rounded text-sm">Clear Background</button>
        </div>
        
        <!-- Settings (Hidden) -->
        <div class="mb-4 hidden">
            <label class="block text-sm font-medium mb-2">Photos per Layout:</label>
            <input type="number" id="photosPerLayout" value="3" min="1" max="6" class="w-full p-2 border rounded">
        </div>
        
        <!-- Photo Border Settings (Hidden) -->
        <div class="mb-4 hidden">
            <label class="block text-sm font-medium mb-2">Photo Border:</label>
            <div class="space-y-2">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Border Width (px):</label>
                    <input type="number" id="borderWidth" value="5" min="0" max="20" class="w-full p-2 border rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Border Color:</label>
                    <div class="flex gap-2">
                        <input type="color" id="borderColor" value="#ffffff" class="w-12 h-8 border rounded cursor-pointer">
                        <input type="text" id="borderColorText" value="#ffffff" class="flex-1 p-2 border rounded text-sm" placeholder="#ffffff">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Border Style:</label>
                    <select id="borderStyle" class="w-full p-2 border rounded text-sm">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed</option>
                        <option value="dotted">Dotted</option>
                        <option value="double">Double</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Top Layer Overlay -->
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Top Layer Overlay:</label>
            <input type="file" id="topLayerUpload" accept="image/*" class="w-full p-2 border rounded">
            <button id="clearTopLayer" class="mt-2 px-3 py-1 bg-red-500 text-white rounded text-sm">Clear Top Layer</button>
            <div class="mt-2 hidden">
                <label class="block text-xs text-gray-600 mb-1">Opacity (%):</label>
                <input type="range" id="topLayerOpacity" min="0" max="100" value="100" class="w-full">
                <span id="opacityValue" class="text-xs text-gray-600">100%</span>
            </div>
        </div>
        
        <!-- Auto Download Settings -->
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Auto Download:</label>
            <div class="space-y-2">
                <label class="flex items-center">
                    <input type="checkbox" id="autoDownloadEnabled" checked class="mr-2">
                    <span class="text-sm">Auto-download after photoshoot</span>
                </label>
                <div class="ml-6">
                    <label class="block text-xs text-gray-600 mb-1">Download delay (seconds):</label>
                    <input type="number" id="downloadDelay" value="3" min="0" max="10" class="w-full p-2 border rounded text-sm">
                    <p class="text-xs text-gray-500 mt-1">Time to wait after photoshoot before auto-download</p>
                </div>
            </div>
        </div>
        
        <button id="closeAdmin" class="w-full bg-gray-500 text-white py-2 rounded">Close Admin</button>
    </div>

    <!-- Camera Section (Fullscreen by default) -->
    <div id="cameraSection" class="fixed inset-0 bg-black z-40">
            <!-- Live Camera Feed (Fullscreen) -->
            <div class="relative w-full h-full">
                <video id="cameraFeed" class="w-full h-full object-cover" autoplay muted></video>
                <canvas id="captureCanvas" class="hidden"></canvas>
                

                
                <!-- Camera Controls Overlay -->
                <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 z-50">
                    <div class="flex gap-4">
                        <button id="startCamera" class="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-full font-bold text-xl shadow-2xl">
                            üìπ Start Camera
                        </button>
                        <button id="startPhotoshoot" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-4 rounded-full font-bold text-xl shadow-2xl hidden">
                            üì∏ Start Photoshoot
                        </button>
                        <button id="stopPhotoshoot" class="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-full font-bold text-xl shadow-2xl hidden">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </div>
                
                <!-- Top Controls -->
                <div class="absolute top-4 left-4 flex gap-2 z-50">
                    <button id="adminToggle" class="bg-black bg-opacity-70 text-white px-4 py-2 rounded-full hover:bg-opacity-90 transition-all">
                        Admin Panel
                    </button>
                </div>
                
                <!-- Countdown Overlay -->
                <div id="countdownOverlay" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-60">
                    <div id="countdownNumber" class="countdown text-white font-bold">5</div>
                </div>
                
                <!-- Flash Effect -->
                <div id="flashEffect" class="absolute inset-0 pointer-events-none z-60"></div>
            </div>
        </div>

    </div>

    <!-- Layout Preview Popup -->
    <div id="layoutPreviewPopup" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="relative bg-white rounded-lg p-8 max-w-5xl max-h-screen">
            <button id="closeLayoutPreview" class="absolute top-4 right-4 bg-gray-200 text-black rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold hover:bg-gray-300 z-10">
                √ó
            </button>
            <h3 class="text-2xl font-bold mb-6 text-center">Your Photo Strip</h3>
            <div id="layoutPreview" class="photo-frame bg-white mx-auto" style="width: 800px; height: 533px;">
                <div id="photoSlots" class="h-full flex gap-1 p-1">
                    <!-- Photo slots will be generated here -->
                </div>
            </div>
            
            <!-- Progress -->
            <div class="mt-6">
                <div class="flex justify-between text-lg text-gray-700 mb-3">
                    <span>Progress</span>
                    <span id="progressText">0/3 photos</span>
                </div>
                <div class="w-full bg-gray-300 rounded-full h-3">
                    <div id="progressBar" class="bg-blue-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Popup Modal -->
    <div id="photoPopup" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="relative max-w-4xl max-h-screen p-4">
            <button id="closePopup" class="absolute top-2 right-2 bg-white text-black rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold hover:bg-gray-200 z-10">
                √ó
            </button>
            <img id="popupImage" src="" alt="Full size photo" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
        </div>
    </div>

    <script>
        class Photobooth {
            constructor() {
                this.camera = null;
                this.currentPhotos = [];
                this.allPhotos = [];
                this.isCapturing = false;
                this.currentPhotoIndex = 0;
                this.photosPerLayout = 3;
                this.layoutSize = '6x4';
                this.backgroundImage = null;
                this.currentPage = 1;
                this.photosPerPage = 12;
                this.borderWidth = 5;
                this.borderColor = '#ffffff';
                this.borderStyle = 'solid';
                this.topLayerImage = null;
                this.topLayerOpacity = 100;
                this.autoDownloadEnabled = true;
                this.downloadDelay = 3;
                
                this.initializeElements();
                this.setupEventListeners();
                this.updateLayoutPreview();
            }
            
            initializeElements() {
                this.elements = {
                    adminPanel: document.getElementById('adminPanel'),
                    adminToggle: document.getElementById('adminToggle'),
                    closeAdmin: document.getElementById('closeAdmin'),
                    layoutSelect: document.getElementById('layoutSelect'),
                    backgroundUpload: document.getElementById('backgroundUpload'),
                    clearBackground: document.getElementById('clearBackground'),
                    photosPerLayoutInput: document.getElementById('photosPerLayout'),
                    borderWidth: document.getElementById('borderWidth'),
                    borderColor: document.getElementById('borderColor'),
                    borderColorText: document.getElementById('borderColorText'),
                    borderStyle: document.getElementById('borderStyle'),
                    topLayerUpload: document.getElementById('topLayerUpload'),
                    clearTopLayer: document.getElementById('clearTopLayer'),
                    topLayerOpacity: document.getElementById('topLayerOpacity'),
                    opacityValue: document.getElementById('opacityValue'),
                    autoDownloadEnabled: document.getElementById('autoDownloadEnabled'),
                    downloadDelay: document.getElementById('downloadDelay'),
                    cameraFeed: document.getElementById('cameraFeed'),
                    captureCanvas: document.getElementById('captureCanvas'),
                    startCamera: document.getElementById('startCamera'),
                    startPhotoshoot: document.getElementById('startPhotoshoot'),
                    stopPhotoshoot: document.getElementById('stopPhotoshoot'),
                    countdownOverlay: document.getElementById('countdownOverlay'),
                    countdownNumber: document.getElementById('countdownNumber'),
                    flashEffect: document.getElementById('flashEffect'),
                    layoutPreview: document.getElementById('layoutPreview'),
                    photoSlots: document.getElementById('photoSlots'),
                    progressText: document.getElementById('progressText'),
                    progressBar: document.getElementById('progressBar'),
                    layoutPreviewPopup: document.getElementById('layoutPreviewPopup'),
                    closeLayoutPreview: document.getElementById('closeLayoutPreview'),

                    photoPopup: document.getElementById('photoPopup'),
                    popupImage: document.getElementById('popupImage'),
                    closePopup: document.getElementById('closePopup')
                };
            }
            
            setupEventListeners() {
                this.elements.adminToggle.addEventListener('click', () => this.toggleAdmin());
                this.elements.closeAdmin.addEventListener('click', () => this.toggleAdmin());
                this.elements.layoutSelect.addEventListener('change', (e) => this.changeLayout(e.target.value));
                this.elements.backgroundUpload.addEventListener('change', (e) => this.handleBackgroundUpload(e));
                this.elements.clearBackground.addEventListener('click', () => this.clearBackground());
                this.elements.photosPerLayoutInput.addEventListener('change', (e) => this.changePhotosPerLayout(e.target.value));
                this.elements.borderWidth.addEventListener('input', (e) => this.updateBorderSettings());
                this.elements.borderColor.addEventListener('input', (e) => this.updateBorderSettings());
                this.elements.borderColorText.addEventListener('input', (e) => this.updateBorderSettings());
                this.elements.borderStyle.addEventListener('change', (e) => this.updateBorderSettings());
                this.elements.topLayerUpload.addEventListener('change', (e) => this.handleTopLayerUpload(e));
                this.elements.clearTopLayer.addEventListener('click', () => this.clearTopLayer());
                this.elements.topLayerOpacity.addEventListener('input', (e) => this.updateTopLayerOpacity(e));
                this.elements.autoDownloadEnabled.addEventListener('change', (e) => this.updateAutoDownloadSettings());
                this.elements.downloadDelay.addEventListener('input', (e) => this.updateAutoDownloadSettings());
                this.elements.startCamera.addEventListener('click', () => this.startCamera());
                this.elements.startPhotoshoot.addEventListener('click', () => this.startPhotoshoot());
                this.elements.stopPhotoshoot.addEventListener('click', () => this.stopPhotoshoot());

                this.elements.closePopup.addEventListener('click', () => this.hidePhotoPopup());
                this.elements.photoPopup.addEventListener('click', (e) => {
                    if (e.target === this.elements.photoPopup) {
                        this.hidePhotoPopup();
                    }
                });
                
                this.elements.closeLayoutPreview.addEventListener('click', () => this.hideLayoutPreview());
                this.elements.layoutPreviewPopup.addEventListener('click', (e) => {
                    if (e.target === this.elements.layoutPreviewPopup) {
                        this.hideLayoutPreview();
                    }
                });
                

                

            }
            
            toggleAdmin() {
                this.elements.adminPanel.classList.toggle('hidden');
            }
            
            changeLayout(layout) {
                this.layoutSize = layout;
                this.updateLayoutPreview();
            }
            
            handleBackgroundUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.backgroundImage = e.target.result;
                        this.updateLayoutPreview();
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            clearBackground() {
                this.backgroundImage = null;
                this.elements.backgroundUpload.value = '';
                this.updateLayoutPreview();
            }
            
            changePhotosPerLayout(count) {
                this.photosPerLayout = 3; // Always keep it at 3 photos
                this.elements.photosPerLayoutInput.value = 3;
                this.updateLayoutPreview();
            }
            
            updateBorderSettings() {
                this.borderWidth = parseInt(this.elements.borderWidth.value) || 0;
                this.borderStyle = this.elements.borderStyle.value;
                
                // Sync color inputs
                if (document.activeElement === this.elements.borderColor) {
                    this.borderColor = this.elements.borderColor.value;
                    this.elements.borderColorText.value = this.borderColor;
                } else if (document.activeElement === this.elements.borderColorText) {
                    const colorValue = this.elements.borderColorText.value;
                    if (/^#[0-9A-F]{6}$/i.test(colorValue)) {
                        this.borderColor = colorValue;
                        this.elements.borderColor.value = colorValue;
                    }
                }
                
                this.updateLayoutPreview();
            }
            
            handleTopLayerUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.topLayerImage = e.target.result;
                        this.updateLayoutPreview();
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            clearTopLayer() {
                this.topLayerImage = null;
                this.elements.topLayerUpload.value = '';
                this.updateLayoutPreview();
            }
            
            updateTopLayerOpacity(event) {
                this.topLayerOpacity = parseInt(event.target.value);
                this.elements.opacityValue.textContent = `${this.topLayerOpacity}%`;
                this.updateLayoutPreview();
            }
            
            updateAutoDownloadSettings() {
                this.autoDownloadEnabled = this.elements.autoDownloadEnabled.checked;
                this.downloadDelay = parseInt(this.elements.downloadDelay.value) || 3;
            }
            
            updateLayoutPreview() {
                const preview = this.elements.layoutPreview;
                const slots = this.elements.photoSlots;
                
                // Update layout dimensions
                if (this.layoutSize === '6x4') {
                    preview.style.width = '800px';
                    preview.style.height = '533px';
                    slots.className = 'h-full flex gap-2 p-2';
                } else {
                    preview.style.width = '400px';
                    preview.style.height = '1200px';
                    slots.className = 'h-full flex flex-col gap-2 p-2';
                }
                
                // Set background
                if (this.backgroundImage) {
                    preview.style.backgroundImage = `url(${this.backgroundImage})`;
                    preview.style.backgroundSize = 'cover';
                    preview.style.backgroundPosition = 'center';
                } else {
                    preview.style.backgroundImage = 'none';
                }
                
                // Create photo slots with specific positioning
                slots.innerHTML = '';
                slots.style.position = 'relative';
                
                if (this.layoutSize === '6x4') {
                    // 6x4 layout positioning - Custom sizing based on quarter frame (doubled for larger preview)
                    const previewQuarterWidth = 800 / 4; // 200px
                    const previewQuarterHeight = 533 / 4; // ~133px
                    
                    const positions = [
                        { position: 'absolute', left: '50px', bottom: '30px', width: `${previewQuarterWidth * 1.8}px`, height: `${previewQuarterHeight * 1.8}px` }, // Picture 1: 1.8x quarter frame
                        { position: 'absolute', right: '20px', top: '30px', width: `${previewQuarterWidth * 1.4}px`, height: `${previewQuarterHeight * 1.5}px` }, // Picture 2: 1.4x width, 1.5x height
                        { position: 'absolute', right: '20px', bottom: '30px', width: `${previewQuarterWidth * 1.4}px`, height: `${previewQuarterHeight * 1.5}px` } // Picture 3: 1.4x width, 1.5x height
                    ];
                    
                    for (let i = 0; i < 3; i++) {
                        const slot = document.createElement('div');
                        slot.className = 'bg-gray-200 rounded border-2 border-dashed border-gray-400 flex items-center justify-center text-gray-500 text-xs';
                        slot.textContent = `${i + 1}`;
                        
                        // Apply positioning
                        Object.assign(slot.style, positions[i]);
                        
                        if (this.currentPhotos[i]) {
                            slot.style.backgroundImage = `url(${this.currentPhotos[i]})`;
                            slot.style.backgroundSize = 'cover';
                            slot.style.backgroundPosition = 'center';
                            slot.textContent = '';
                            slot.className = slot.className.replace('bg-gray-200 border-dashed border-gray-400', 'bg-white');
                        }
                        
                        // Apply border styling
                        if (this.borderWidth > 0) {
                            slot.style.border = `${this.borderWidth}px ${this.borderStyle} ${this.borderColor}`;
                        } else {
                            slot.style.border = 'none';
                        }
                        
                        slots.appendChild(slot);
                    }
                } else {
                    // 2x6 layout - vertical stacking with space at bottom (larger preview)
                    slots.style.paddingBottom = '160px'; // Space for background design at bottom
                    
                    for (let i = 0; i < 3; i++) {
                        const slot = document.createElement('div');
                        slot.className = 'bg-gray-200 rounded border-2 border-dashed border-gray-400 flex items-center justify-center text-gray-500 text-lg mb-8';
                        slot.style.height = '200px';
                        slot.textContent = `Photo ${i + 1}`;
                        
                        if (this.currentPhotos[i]) {
                            slot.style.backgroundImage = `url(${this.currentPhotos[i]})`;
                            slot.style.backgroundSize = 'cover';
                            slot.style.backgroundPosition = 'center';
                            slot.textContent = '';
                            slot.className = slot.className.replace('bg-gray-200 border-dashed border-gray-400', 'bg-white');
                        }
                        
                        // Apply border styling
                        if (this.borderWidth > 0) {
                            slot.style.border = `${this.borderWidth}px ${this.borderStyle} ${this.borderColor}`;
                        } else {
                            slot.style.border = 'none';
                        }
                        
                        slots.appendChild(slot);
                    }
                }
                
                // Add top layer overlay if present
                if (this.topLayerImage) {
                    const topLayer = document.createElement('div');
                    topLayer.style.position = 'absolute';
                    topLayer.style.top = '0';
                    topLayer.style.left = '0';
                    topLayer.style.width = '100%';
                    topLayer.style.height = '100%';
                    topLayer.style.backgroundImage = `url(${this.topLayerImage})`;
                    topLayer.style.backgroundSize = 'cover';
                    topLayer.style.backgroundPosition = 'center';
                    topLayer.style.opacity = this.topLayerOpacity / 100;
                    topLayer.style.pointerEvents = 'none';
                    topLayer.style.zIndex = '10';
                    slots.appendChild(topLayer);
                }
                
                this.updateProgress();
            }
            
            async startCamera() {
                try {
                    this.camera = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 1280, height: 720 } 
                    });
                    this.elements.cameraFeed.srcObject = this.camera;
                    
                    this.elements.startCamera.classList.add('hidden');
                    this.elements.startPhotoshoot.classList.remove('hidden');
                } catch (error) {
                    alert('Camera access denied or not available');
                }
            }
            
            async startPhotoshoot() {
                if (this.isCapturing) return;
                
                this.isCapturing = true;
                this.currentPhotos = [];
                this.currentPhotoIndex = 0;
                
                this.elements.startPhotoshoot.classList.add('hidden');
                this.elements.stopPhotoshoot.classList.remove('hidden');
                
                await this.captureSequence();
            }
            
            async captureSequence() {
                for (let i = 0; i < this.photosPerLayout; i++) {
                    if (!this.isCapturing) break;
                    
                    this.currentPhotoIndex = i;
                    
                    // Countdown (5 seconds for first, 3 seconds for others)
                    const countdownTime = i === 0 ? 1 : 1;
                    await this.showCountdown(countdownTime);
                    
                    if (!this.isCapturing) break;
                    
                    // Capture photo
                    const photo = this.capturePhoto();
                    this.currentPhotos.push(photo);
                    this.updateLayoutPreview();
                    
                    // Flash effect
                    this.elements.flashEffect.classList.add('capture-flash');
                    setTimeout(() => {
                        this.elements.flashEffect.classList.remove('capture-flash');
                    }, 300);
                    
                    // Short pause between photos
                    if (i < this.photosPerLayout - 1) {
                        await this.delay(1000);
                    }
                }
                
                if (this.isCapturing) {
                    this.completePhotoshoot();
                }
            }
            
            showCountdown(seconds) {
                return new Promise((resolve) => {
                    this.elements.countdownOverlay.classList.remove('hidden');
                    
                    let count = seconds;
                    this.elements.countdownNumber.textContent = count;
                    
                    const interval = setInterval(() => {
                        count--;
                        if (count > 0) {
                            this.elements.countdownNumber.textContent = count;
                        } else {
                            this.elements.countdownNumber.textContent = 'SMILE!';
                            setTimeout(() => {
                                this.elements.countdownOverlay.classList.add('hidden');
                                clearInterval(interval);
                                resolve();
                            }, 500);
                        }
                    }, 1000);
                });
            }
            
            capturePhoto() {
                const canvas = this.elements.captureCanvas;
                const video = this.elements.cameraFeed;
                const ctx = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                ctx.drawImage(video, 0, 0);
                return canvas.toDataURL('image/jpeg', 0.8);
            }
            
            async completePhotoshoot() {
                // Show layout preview popup first
                this.showLayoutPreview();
                
                // Create final layout
                const finalLayout = await this.createFinalLayout();
                
                // Wait a moment then start auto-download countdown
                setTimeout(() => {
                    this.hideLayoutPreview();
                    this.showAutoDownloadCountdown(finalLayout);
                }, 3000); // Show preview for 3 seconds
            }
            
            showAutoDownloadCountdown(photoData) {
                // Show countdown overlay with download message
                this.elements.countdownOverlay.classList.remove('hidden');
                
                let count = this.downloadDelay;
                this.elements.countdownNumber.textContent = `Auto-downloading in ${count}...`;
                this.elements.countdownNumber.style.fontSize = '3rem'; // Smaller text for longer message
                
                const interval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        this.elements.countdownNumber.textContent = `Auto-downloading in ${count}...`;
                    } else {
                        this.elements.countdownNumber.textContent = 'Downloading!';
                        setTimeout(() => {
                            // Download the photo with timestamp
                            this.downloadPhoto(photoData, Date.now());
                            
                            // Hide overlay and stop photoshoot
                            this.elements.countdownOverlay.classList.add('hidden');
                            this.elements.countdownNumber.style.fontSize = '8rem'; // Reset font size
                            this.stopPhotoshoot();
                            clearInterval(interval);
                        }, 500);
                    }
                }, 1000);
            }
            
            createFinalLayout() {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas size based on layout
                    if (this.layoutSize === '6x4') {
                        canvas.width = 600;
                        canvas.height = 400;
                    } else {
                        canvas.width = 300;
                        canvas.height = 900;
                    }
                    
                    // Draw background first
                    if (this.backgroundImage) {
                        const bgImg = new Image();
                        bgImg.onload = () => {
                            ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
                            this.drawPhotosOnCanvasAsync(ctx, canvas).then(() => {
                                this.drawTopLayerOnCanvas(ctx, canvas).then(() => {
                                    resolve(canvas.toDataURL('image/jpeg', 0.9));
                                });
                            });
                        };
                        bgImg.src = this.backgroundImage;
                    } else {
                        ctx.fillStyle = '#f0f0f0';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        this.drawPhotosOnCanvasAsync(ctx, canvas).then(() => {
                            this.drawTopLayerOnCanvas(ctx, canvas).then(() => {
                                resolve(canvas.toDataURL('image/jpeg', 0.9));
                            });
                        });
                    }
                });
            }
            
            drawPhotosOnCanvasAsync(ctx, canvas) {
                return new Promise((resolve) => {
                    const padding = 30;
                    let loadedCount = 0;
                    const totalPhotos = Math.min(this.currentPhotos.length, 3);
                    
                    if (totalPhotos === 0) {
                        resolve();
                        return;
                    }
                    
                    if (this.layoutSize === '6x4') {
                        // 6x4 layout - Custom sizing based on quarter frame
                        const quarterFrameWidth = canvas.width / 4;
                        const quarterFrameHeight = canvas.height / 4;
                        
                        // Photo positions for 6x4 layout - ADJUST THESE VALUES TO CHANGE OUTPUT POSITIONS
                        const positions = [
                            // Picture 1 (lower left): Change x=25 (left distance), y calculation (bottom distance), width/height multipliers
                            { x: 25, y: canvas.height - (quarterFrameHeight * 1.8) - 15, width: quarterFrameWidth * 1.8, height: quarterFrameHeight * 1.8 },
                            
                            // Picture 2 (upper right): Change x calculation (right distance), y=15 (top distance), width/height multipliers  
                            { x: canvas.width - (quarterFrameWidth * 1.4) - 10, y: 15, width: quarterFrameWidth * 1.4, height: quarterFrameHeight * 1.5 },
                            
                            // Picture 3 (lower right): Change x calculation (right distance), y calculation (bottom distance), width/height multipliers
                            { x: canvas.width - (quarterFrameWidth * 1.4) - 10, y: canvas.height - (quarterFrameHeight * 1.5) - 15, width: quarterFrameWidth * 1.4, height: quarterFrameHeight * 1.5 }
                        ];
                        
                        this.currentPhotos.forEach((photo, index) => {
                            if (index < 3 && positions[index]) {
                                const img = new Image();
                                img.onload = () => {
                                    const pos = positions[index];
                                    
                                    // Draw photo
                                    ctx.drawImage(img, pos.x, pos.y, pos.width, pos.height);
                                    

                                    
                                    loadedCount++;
                                    if (loadedCount === totalPhotos) resolve();
                                };
                                img.src = photo;
                            }
                        });
                    } else {
                        // 2x6 layout - vertical strip layout with space at bottom
                        const photoWidth = canvas.width - padding * 2;
                        const photoHeight = 160;
                        const gap = 30;
                        const bottomSpace = 150; // Space reserved for background design
                        
                        this.currentPhotos.forEach((photo, index) => {
                            if (index < 3) {
                                const img = new Image();
                                img.onload = () => {
                                    const x = padding;
                                    const y = padding + index * (photoHeight + gap);
                                    
                                    // Draw photo
                                    ctx.drawImage(img, x, y, photoWidth, photoHeight);
                                    

                                    
                                    loadedCount++;
                                    if (loadedCount === totalPhotos) resolve();
                                };
                                img.src = photo;
                            }
                        });
                    }
                });
            }
            
            drawTopLayerOnCanvas(ctx, canvas) {
                return new Promise((resolve) => {
                    if (!this.topLayerImage) {
                        resolve();
                        return;
                    }
                    
                    const topImg = new Image();
                    topImg.onload = () => {
                        // Save current context state
                        ctx.save();
                        
                        // Set opacity for top layer
                        ctx.globalAlpha = this.topLayerOpacity / 100;
                        
                        // Draw top layer covering entire canvas
                        ctx.drawImage(topImg, 0, 0, canvas.width, canvas.height);
                        
                        // Restore context state
                        ctx.restore();
                        
                        resolve();
                    };
                    topImg.src = this.topLayerImage;
                });
            }
            
            stopPhotoshoot() {
                this.isCapturing = false;
                this.currentPhotos = [];
                this.currentPhotoIndex = 0;
                
                this.elements.startPhotoshoot.classList.remove('hidden');
                this.elements.stopPhotoshoot.classList.add('hidden');
                this.elements.countdownOverlay.classList.add('hidden');
                
                this.updateLayoutPreview();
            }
            
            updateProgress() {
                const progress = (this.currentPhotos.length / this.photosPerLayout) * 100;
                this.elements.progressBar.style.width = `${progress}%`;
                this.elements.progressText.textContent = `${this.currentPhotos.length}/${this.photosPerLayout} photos`;
            }
            

            
            downloadPhoto(photoData, index) {
                const link = document.createElement('a');
                link.download = `photobooth-${index}-${Date.now()}.jpg`;
                link.href = photoData;
                link.click();
            }
            

            
            showPhotoPopup(photoSrc) {
                this.elements.popupImage.src = photoSrc;
                this.elements.photoPopup.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
            
            hidePhotoPopup() {
                this.elements.photoPopup.classList.add('hidden');
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
            
            showLayoutPreview() {
                this.elements.layoutPreviewPopup.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
            
            hideLayoutPreview() {
                this.elements.layoutPreviewPopup.classList.add('hidden');
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
            

            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // Initialize the photobooth when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new Photobooth();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9802302cb706bc45',t:'MTc1ODA0NDgzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
